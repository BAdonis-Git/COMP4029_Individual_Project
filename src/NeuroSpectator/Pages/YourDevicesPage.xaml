<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:NeuroSpectator.PageModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="NeuroSpectator.Pages.YourDevicesPage"
             Title="Your Devices"
             BackgroundColor="#1E1E1E">

    <ContentPage.Resources>
        <Style x:Key="HeaderLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="TextColor" Value="#CCCCCC"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>

        <Style x:Key="SubHeaderLabelStyle" TargetType="Label">
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="TextColor" Value="#AAAAAA"/>
            <Setter Property="FontAttributes" Value="Bold"/>
        </Style>

        <Style x:Key="NormalLabelStyle" TargetType="Label">
            <Setter Property="TextColor" Value="#CCCCCC"/>
            <Setter Property="FontSize" Value="14"/>
        </Style>

        <Style x:Key="CardStyle" TargetType="Frame">
            <Setter Property="BackgroundColor" Value="#2D2D2D"/>
            <Setter Property="BorderColor" Value="#444444"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Padding" Value="15"/>
            <Setter Property="Margin" Value="5"/>
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#B388FF"/>
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="FontAttributes" Value="Bold"/>
            <Setter Property="CornerRadius" Value="5"/>
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button">
            <Setter Property="BackgroundColor" Value="#444444"/>
            <Setter Property="TextColor" Value="White"/>
            <Setter Property="CornerRadius" Value="5"/>
        </Style>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*" Padding="15">
        <Label 
            Text="Your Devices"
            Grid.Row="0"
            FontSize="24"
            TextColor="#B388FF"
            HorizontalOptions="Center"
            Margin="0,0,0,15"/>

        <!-- Main content area -->
        <Grid Grid.Row="1" ColumnDefinitions="1*,1*" RowDefinitions="*,*">

            <!-- Connected Device Panel -->
            <Frame Grid.Column="0" Grid.Row="0" 
                   Style="{StaticResource CardStyle}">
                <Grid RowDefinitions="Auto,*">
                    <Label 
                        Text="Connected Device"
                        Style="{StaticResource HeaderLabelStyle}"/>

                    <ScrollView Grid.Row="1">
                        <Grid>
                            <!-- Connected Device View -->
                            <VerticalStackLayout Spacing="15" IsVisible="{Binding IsConnected}">
                                <!-- Device Name -->
                                <Label 
                                    Text="{Binding CurrentDevice.Name}" 
                                    FontSize="18" 
                                    TextColor="#B388FF"
                                    HorizontalOptions="Center"/>

                                <!-- Battery Status Circle -->
                                <Grid HorizontalOptions="Center" VerticalOptions="Center" 
                                      WidthRequest="120" HeightRequest="120">
                                    <Ellipse Stroke="#444444" StrokeThickness="10" 
                                             WidthRequest="120" HeightRequest="120"/>

                                    <!-- Battery Progress Circle - We'll replace Arc with a custom approach -->
                                    <Path Stroke="#92D36E" StrokeThickness="10">
                                        <Path.Data>
                                            <PathGeometry>
                                                <PathFigure IsClosed="False" StartPoint="60,10">
                                                    <ArcSegment Size="50,50" 
                                                                 Point="60,110" 
                                                                 SweepDirection="Clockwise" 
                                                                 IsLargeArc="{Binding BatteryPercentIsLargeArc}"/>
                                                </PathFigure>
                                            </PathGeometry>
                                        </Path.Data>
                                    </Path>

                                    <VerticalStackLayout HorizontalOptions="Center" VerticalOptions="Center">
                                        <Label Text="{Binding BatteryPercentText}" 
                                               TextColor="#92D36E" 
                                               FontSize="16" 
                                               HorizontalOptions="Center"/>
                                        <Label Text="Charged" 
                                               TextColor="#92D36E" 
                                               FontSize="12" 
                                               HorizontalOptions="Center"/>
                                    </VerticalStackLayout>
                                </Grid>

                                <!-- Connection Status -->
                                <HorizontalStackLayout HorizontalOptions="Center">
                                    <Label Text="Connected " 
                                           TextColor="#92D36E" 
                                           FontSize="16"/>
                                    <Label Text="âœ“" 
                                           TextColor="#92D36E" 
                                           FontSize="16"/>
                                    <Label Text=" (Stable)" 
                                           TextColor="#CCCCCC" 
                                           FontSize="16"/>
                                </HorizontalStackLayout>

                                <!-- Disconnect Button -->
                                <Button Text="Disconnect" 
                                        Command="{Binding DisconnectCommand}"
                                        Style="{StaticResource SecondaryButtonStyle}"/>
                            </VerticalStackLayout>

                            <!-- No Connected Device View -->
                            <VerticalStackLayout Spacing="15" IsVisible="{Binding IsNotConnected}">
                                <Label Text="No Device Connected" 
                                       TextColor="#AAAAAA" 
                                       HorizontalOptions="Center"/>

                                <!-- Available Devices Section when not connected -->
                                <Label Text="Available Devices" 
                                       Style="{StaticResource SubHeaderLabelStyle}" 
                                       Margin="0,10,0,0"/>

                                <CollectionView 
                                    ItemsSource="{Binding AvailableDevices}"
                                    SelectedItem="{Binding SelectedDevice}"
                                    SelectionMode="Single"
                                    HeightRequest="150">
                                    <CollectionView.EmptyView>
                                        <Label Text="No devices found. Start scanning to discover Muse headbands."
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               TextColor="#AAAAAA"/>
                                    </CollectionView.EmptyView>
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate>
                                            <Frame Style="{StaticResource CardStyle}" Margin="0,2">
                                                <VerticalStackLayout>
                                                    <Label Text="{Binding Name}" 
                                                           TextColor="White" 
                                                           FontAttributes="Bold"/>
                                                    <Label Text="{Binding BluetoothMac}" 
                                                           TextColor="#AAAAAA" 
                                                           FontSize="12"/>
                                                    <Label Text="{Binding RSSI, StringFormat='Signal: {0:F1} dBm'}" 
                                                           TextColor="#AAAAAA" 
                                                           FontSize="12"/>
                                                </VerticalStackLayout>
                                            </Frame>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                </CollectionView>

                                <!-- Scan Controls -->
                                <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                    <Button Grid.Column="0" 
                                            Text="Start Scanning" 
                                            Command="{Binding StartScanCommand}"
                                            IsEnabled="{Binding CanScan}"
                                            Style="{StaticResource SecondaryButtonStyle}"/>

                                    <Button Grid.Column="1" 
                                            Text="Stop Scanning" 
                                            Command="{Binding StopScanCommand}"
                                            IsEnabled="{Binding IsScanning}"
                                            Style="{StaticResource SecondaryButtonStyle}"/>
                                </Grid>

                                <!-- Connect Button -->
                                <Button Text="Connect" 
                                        Command="{Binding ConnectCommand}"
                                        IsEnabled="{Binding CanConnect}"
                                        Style="{StaticResource PrimaryButtonStyle}"/>

                                <!-- Initialize Button (only shown if needed) -->
                                <Button Text="Initialize Muse Manager" 
                                        Command="{Binding InitializeCommand}"
                                        IsEnabled="{Binding CanInitialize}"
                                        IsVisible="{Binding CanInitialize}"
                                        Style="{StaticResource SecondaryButtonStyle}"/>
                            </VerticalStackLayout>
                        </Grid>
                    </ScrollView>
                </Grid>
            </Frame>

            <!-- Active Device Settings Panel -->
            <Frame Grid.Column="0" Grid.Row="1" 
                   Style="{StaticResource CardStyle}">
                <Grid RowDefinitions="Auto,*">
                    <Label 
                        Text="Active Device Settings"
                        Style="{StaticResource HeaderLabelStyle}"/>

                    <ScrollView Grid.Row="1">
                        <Grid>
                            <VerticalStackLayout Spacing="15" IsVisible="{Binding IsConnected}">
                                <!-- Settings List -->
                                <Border BackgroundColor="#383838" StrokeThickness="0" StrokeShape="RoundRectangle 5">
                                    <VerticalStackLayout Spacing="5" Padding="10">
                                        <Label Text="{Binding CurrentDeviceSettings.Preset, StringFormat='Preset: {0}'}" 
                                               Style="{StaticResource NormalLabelStyle}"/>
                                        <Label Text="{Binding CurrentDeviceSettings.NotchFilter, StringFormat='Notch Filter: {0}'}" 
                                               Style="{StaticResource NormalLabelStyle}"/>
                                        <Label Text="{Binding CurrentDeviceSettings.SampleRate, StringFormat='Sample Rate: {0}'}" 
                                               Style="{StaticResource NormalLabelStyle}"/>
                                        <Label Text="{Binding CurrentDeviceSettings.EegChannels, StringFormat='EEG Channels: {0}'}" 
                                               Style="{StaticResource NormalLabelStyle}"/>
                                    </VerticalStackLayout>
                                </Border>

                                <!-- Preset Selector -->
                                <Button Text="Presets" 
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding ShowPresetsCommand}"/>

                                <!-- Save Settings Button -->
                                <Button Text="Save Settings" 
                                        Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding SaveDeviceSettingsCommand}"/>
                            </VerticalStackLayout>

                            <!-- No Device Connected View -->
                            <Label IsVisible="{Binding IsNotConnected}" 
                                   Text="Connect to a device to view and configure settings"
                                   TextColor="#AAAAAA" 
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Grid>
                    </ScrollView>
                </Grid>
            </Frame>

            <!-- Your Devices List Panel -->
            <Frame Grid.Column="1" Grid.Row="0" Grid.RowSpan="2" 
                   Style="{StaticResource CardStyle}">
                <Grid RowDefinitions="Auto,*">
                    <Label 
                        Text="Your Devices"
                        Style="{StaticResource HeaderLabelStyle}"/>

                    <VerticalStackLayout Grid.Row="1" Spacing="10">
                        <!-- Supported Devices Button -->
                        <Button Text="ðŸ”Œ Supported Devices" 
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding ShowSupportedDevicesCommand}"/>

                        <!-- Devices Collection -->
                        <CollectionView 
                            ItemsSource="{Binding StoredDevices}"
                            SelectedItem="{Binding SelectedStoredDevice}"
                            SelectionMode="Single"
                            HeightRequest="500">
                            <CollectionView.EmptyView>
                                <Label Text="No saved devices found. Connect to a device to save its settings."
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="#AAAAAA"/>
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Style="{StaticResource CardStyle}" Margin="5,5,5,10">
                                        <Grid RowDefinitions="Auto,*,Auto" RowSpacing="10">
                                            <Label Text="{Binding Name}" 
                                                   Grid.Row="0"
                                                   TextColor="White" 
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center"/>

                                            <Border Grid.Row="1" 
                                                    BackgroundColor="#444444" 
                                                    StrokeThickness="0"
                                                    StrokeShape="RoundRectangle 5"
                                                    HeightRequest="150" 
                                                    WidthRequest="150"
                                                    HorizontalOptions="Center">
                                                <Label Text="{Binding DeviceType}" 
                                                       HorizontalOptions="Center" 
                                                       VerticalOptions="Center"
                                                       TextColor="#AAAAAA"/>
                                            </Border>

                                            <Button Grid.Row="2" 
                                                    Text="Presets" 
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type pageModels:YourDevicesPageModel}}, Path=EditDevicePresetsCommand}"
                                                    CommandParameter="{Binding .}"
                                                    Style="{StaticResource PrimaryButtonStyle}"/>
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- Status Display at Bottom - Optional -->
            <Label Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1"
                   Text="{Binding StatusText}"
                   TextColor="#AAAAAA"
                   FontSize="12"
                   VerticalOptions="End"
                   HorizontalOptions="Center"
                   Margin="0,0,0,5"/>
        </Grid>
    </Grid>
</ContentPage>